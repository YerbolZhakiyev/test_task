pipeline {
    agent any
    stages {
        stage('Define version') {
            steps {
                script {
                    def last_build_number = readFile '/tmp/last_build_number.txt'
                    env.LAST_BUILD_NUMBER = last_build_number
                }
            }
        }
        stage('Make changes on site') {
            agent {
                label '2'
            }
            steps {
                script {
                    sh 'ssh-keyscan -H 172.31.3.14 >> ~/.ssh/known_hosts'
                    sh 'ifconfig'
                    sh "ssh -i /home/ubuntu/keypair_test.pem ubuntu@172.31.3.14 -tt 'cd /home/ubuntu; sudo docker pull registry.gitlab.com/yerbolzhakiyev/test_task:${env.LAST_BUILD_NUMBER}; sudo docker run -p 8080:80 --name my-website registry.gitlab.com/yerbolzhakiyev/test_task; sudo systemctl restart nginx'" 
                }
            }
        }
    }
}
